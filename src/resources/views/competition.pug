extends ./layouts/common
block main
    section.competition
        .row
            .col-sm-9
                .card.shadow.border-0.p-2.rounded-3
                    .card-body
                        .d-flex.align-items-center
                            button.btn.btn-primary(data-bs-toggle="modal" data-bs-target="#competitionModal") Tạo phòng
                            .ms-4
                                .input-group
                                    span#basic-addon1.input-group-text
                                        ion-icon(name='search')
                                    input.form-control(type='text', placeholder='Tìm kiếm thành viên', aria-label='Username', aria-describedby='basic-addon1')
                            .ms-4
                                select.form-select(aria-label='Default select example')
                                    option(selected) -- Chọn khối --
                                    option(value='1') Khối 12
                                    option(value='2') Khối 11
                                    option(value='3') Khối 10
                        .table-responsive.pt-4
                            table.table.table-hover
                                thead
                                    tr
                                        th(scope="col") STT
                                        th(scope="col") Chủ phòng
                                        th(scope="col") Khối
                                        th(scope="col") Chủ đề
                                        th(scope="col") Thành viên
                                        th(scope="col") Trạng thái
                                        th(scope="col")
                                tbody
                                    tr.align-middle
                                        td.pt-3.pb-3(scope="row") 1
                                        td
                                            img.rounded-pill(src="/img/nobody.jpg" width=30 height=30)
                                            span.ms-2 Huỳnh Hoàng
                                        td Khối 12
                                        td 
                                            span.fw-bold MÔN TOÁN: 
                                            span Cực trị của hàm số
                                        td 1/10
                                        td.fw-bold.text-warning Đang thi...
                                        td
                                            a.text-primary(href="") Tham gia
        .chat
            .msger
                header.msger-header
                    .msger-header-title.d-flex.align-items-center
                        span
                            ion-icon(name='chatbubbles') 
                        span.ms-2.fw-bold Chat
                        span#counter
                    .msger-header-options
                        span.fs-5
                            ion-icon(name="remove")
                main.msger-chat
                    .msg-content
                    .msg-loading
                .msger-inputarea
                    input.msger-input(type='text', placeholder='Aa')
                    button.msger-send-btn(type='button')
                        ion-icon(name='paper-plane')
        .chat-show
            .d-flex.align-items-center.justify-content-center.h-100
                span.text-white.fs-4
                    ion-icon(name='chatbubbles')
            span.position-absolute.top-0.start-100.translate-middle.badge.rounded-pill.bg-danger#count-message
    #competitionModal.modal.fade(tabindex='-1', aria-labelledby='competitionModalLabel', aria-hidden='true')
        .modal-dialog(style="transition: all 0.3s ease")
            .modal-content
                .modal-header
                    h5#competitionModalLabel.modal-title Tạo phòng đấu
                    button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
                .modal-body
                    .row
                        .col-sm-6 
                            .mb-2.fw-bold Chọn khối
                            select.form-select(aria-label='Default select example')
                                option(selected) -- Chọn khối --
                                option(value='1') Khối 12
                                option(value='2') Khối 11
                                option(value='3') Khối 10
                        .col-sm-6
                            .mb-2.fw-bold Chọn môn
                            select.form-select(aria-label='Default select example')
                                option(selected) -- Chọn môn --
                                option(value='1') Khối 12
                                option(value='2') Khối 11
                                option(value='3') Khối 10
                    .row.mt-4
                        .col-sm-12
                            .mb-2.fw-bold Chọn chủ đề
                            select.form-select(aria-label='Default select example')
                                option(selected) -- Chọn chủ đề --
                                option(value='1') One
                                option(value='2') Two
                                option(value='3') Three

                .modal-footer
                    button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Hủy
                    button.btn.btn-primary(type='button') Tạo phòng
    script.
        const socket = io();

        //- socket.on('getCounter', function (counter) {
        //-     $("#counter").text(counter);
        //- });

        socket.on("server-send-count-message", (data) => {
            $("#count-message").html(data);
        });

        socket.on("server-send-message", (data) => {
            if (data.username === $(".user__info .username").text()) {
                $(".msg-content").append(`
                    <div class='msg right-msg'>
                        <div class='ms-2'>
                            <div class='msg-img' style='background-image: url(${data.avatar})'></div>
                        </div>
                        <div class='msg-bubble'>
                            <div class='msg-info'>
                                <div class='msg-info-name'>${data.name}</div>
                                <div class='msg-info-time'>${data.time}</div>
                            </div>
                            <div class='msg-text'>${data.message}</div>
                        </div>
                    </div>
                `);
            } else {
                $(".msg-content").append(`
                    <div class='msg left-msg'>
                        <div class='me-2'>
                            <div class='msg-img' style='background-image: url(${data.avatar})'></div>
                        </div>
                        <div class='msg-bubble'>
                            <div class='msg-info'>
                                <div class='msg-info-name'>${data.name}</div>
                                <div class='msg-info-time'>${data.time}</div>
                            </div>
                            <div class='msg-text'>${data.message}</div>
                        </div>
                    </div>
                `);
            }
        });

        socket.on("user-writing-message", (data) => {
            if (data.username === $(".user__info .username").text()) {
                $(".msg-loading").html("");
            } else {
                $(".msg-loading").html(`
                    <div class='msg left-msg'>
                        <div class='me-2'>
                            <div class='msg-img' style='background-image: url(${data.avatar})'></div>
                        </div>
                        <div class='msg-bubble'>
                            <img src='/img/loading.gif' width='40' />
                        </div>
                    </div>
                `);
            }
        });

        socket.on("user-stopping-message", () => {
            $(".msg-loading").html("");
        });

        document.addEventListener('DOMContentLoaded', function() {
            var chat = $(".chat");
            var chatShow = $(".chat-show");
            var closeChat = $(".msger-header-options");

            closeChat.click(function () {
                chat.hide(400);
                chatShow.show(400);
            })

            chatShow.click(function () {
                $(this).hide(400);
                chat.show(400);
            })

            $(".msger-send-btn").click(function () {
                var dt = new Date();
                let time;
                if (dt.getMinutes() > 9) {
                    time = dt.getHours() + ":" + dt.getMinutes();
                } else {
                    time = dt.getHours() + ":" + "0" + dt.getMinutes();
                }
                var data = {
                    "name": $(".user__info .name").text(),
                    "username": $(".user__info .username").text(),
                    "avatar": $(".user__avatar img").attr("src"),
                    "message": $(".msger-input").val(),
                    "time": time,
                }
                socket.emit("user-send-message", data);
                $(".msger-input").val("");
            })

            $(".msger-input").keyup(function (e) {
                if (e.keyCode === 13) {
                    var dt = new Date();
                    let time;
                    if (dt.getMinutes() > 9) {
                        time = dt.getHours() + ":" + dt.getMinutes();
                    } else {
                        time = dt.getHours() + ":" + "0" + dt.getMinutes();
                    }
                    var data = {
                        "name": $(".user__info .name").text(),
                        "username": $(".user__info .username").text(),
                        "avatar": $(".user__avatar img").attr("src"),
                        "message": $(".msger-input").val(),
                        "time": time,
                    }
                    socket.emit("user-send-message", data);
                    $(this).val("");
                }
            })

            $(".msger-input").focusin(function() {
                var data = {
                    "username": $(".user__info .username").text(),
                    "avatar": $(".user__avatar img").attr("src"),
                }
                socket.emit("writing-message", data);
            });

            $(".msger-input").focusout(function() {
                socket.emit("stopping-message");
            });
        })           